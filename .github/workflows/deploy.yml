name: Electric Book Deploy Workflow

on:
  workflow_call:
    inputs:
      config-file:
        description: 'Path to deploy configuration file'
        required: false
        default: '.github/workflows/deploy.config.json'
        type: string
      node-version:
        description: 'Node.js version to use'
        required: false
        default: '22'
        type: string
      ruby-version:
        description: 'Ruby version to use'
        required: false
        default: '3.2'
        type: string
    secrets:
      ORG_DEPLOY_TOKEN:
        description: 'GitHub token for deployment'
        required: true

jobs:
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      skip_book_server: ${{ steps.check_config.outputs.skip_book_server }}
      should_build: ${{ steps.check_builds.outputs.should_build }}
      should_deploy: ${{ steps.check_branch.outputs.should_deploy }}
      deploy_bucket: ${{ steps.load_config.outputs.deploy_bucket }}
      deploy_configs: ${{ steps.load_config.outputs.deploy_configs }}
      build_dirs: ${{ steps.load_config.outputs.build_dirs }}
      build_configs: ${{ steps.load_config.outputs.build_configs }}
      target_branch: ${{ steps.check_branch.outputs.target_branch }}

    steps:
    - name: Checkout config file
      uses: actions/checkout@v4
      with:
        sparse-checkout: ${{ inputs.config-file }}
        fetch-depth: 1

    - name: Load deployment configuration
      id: load_config
      run: |
        CONFIG_FILE="${{ inputs.config-file }}"
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ ERROR: $CONFIG_FILE file not found"
          exit 1
        fi
        
        BOOK_SERVER_EXISTS=$(jq -r 'has("book-server")' "$CONFIG_FILE")
        if [[ "${BOOK_SERVER_EXISTS}" != "true" ]]; then
          echo "ðŸ“š No book-server configuration found, skipping deployment."
          echo "skip_book_server=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        DEPLOY_BUCKET=$(jq -r '.["book-server"].bucket' "$CONFIG_FILE")
        DEPLOY_CONFIGS=$(jq -r '.["book-server"].configs | join(",")' "$CONFIG_FILE")
        BUILD_DIRS=$(jq -r '.["book-server"].builds | map(.dir) | join(",")' "$CONFIG_FILE")
        BUILD_CONFIGS=$(jq -r '.["book-server"].builds | map(.configs | if length > 0 then join(",") else " " end) | join(";")' "$CONFIG_FILE")
        
        echo "deploy_bucket=${DEPLOY_BUCKET}" >> $GITHUB_OUTPUT
        echo "deploy_configs=${DEPLOY_CONFIGS}" >> $GITHUB_OUTPUT
        echo "build_dirs=${BUILD_DIRS}" >> $GITHUB_OUTPUT
        echo "build_configs=${BUILD_CONFIGS}" >> $GITHUB_OUTPUT
        echo "skip_book_server=false" >> $GITHUB_OUTPUT

    - name: Check for builds
      id: check_builds
      if: steps.load_config.outputs.skip_book_server == 'false'
      run: |
        BUILD_COUNT=$(jq -r '.["book-server"].builds | length' "${{ inputs.config-file }}")
        if [[ "${BUILD_COUNT}" -eq 0 ]]; then
          echo "ðŸ§± No builds configured, skipping deployment."
          echo "should_build=false" >> $GITHUB_OUTPUT
        else
          echo "should_build=true" >> $GITHUB_OUTPUT
        fi

    - name: Check if branch is allowed for deployment
      id: check_branch
      if: steps.check_builds.outputs.should_build == 'true'
      run: |
        CURRENT_BRANCH="${{ github.ref_name }}"
        if [ "$CURRENT_BRANCH" != "live" ] && [ "$CURRENT_BRANCH" != "staging" ]; then
          echo "âŒ Branch '${CURRENT_BRANCH}' is not 'live' or 'staging', skipping deployment."
          echo "should_deploy=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… Branch '${CURRENT_BRANCH}' is allowed for deployment."
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "target_branch=${CURRENT_BRANCH}" >> $GITHUB_OUTPUT
        fi

  deploy-to-book-server:
    needs: pre-check
    if: needs.pre-check.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'npm'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ inputs.ruby-version }}
        bundler-cache: true

    - name: Install dependencies
      run: npm run setup

    - name: Build project
      run: |
        IFS=',' read -ra DIRS <<< "${{ needs.pre-check.outputs.build_dirs }}"
        IFS=';' read -ra CONFIGS_GROUPS <<< "${{ needs.pre-check.outputs.build_configs }}"
        
        if [[ ${#DIRS[@]} -ne ${#CONFIGS_GROUPS[@]} ]]; then
          echo "âŒ ERROR: Mismatch between build directories and configs."
          exit 1
        fi
        
        mkdir -p _build_staging
        
        for i in "${!DIRS[@]}"; do
          DIR_NAME="${DIRS[$i]}"
          CONFIG_GROUP="${CONFIGS_GROUPS[$i]// /}"
          BUILD_DIR="/${DIR_NAME#*/}"
          
          if [[ -n "${{ needs.pre-check.outputs.deploy_configs }}" && -n "${CONFIG_GROUP}" ]]; then
            FULL_CONFIGS="${{ needs.pre-check.outputs.deploy_configs }},_configs/${CONFIG_GROUP}"
          elif [[ -n "${CONFIG_GROUP}" ]]; then
            FULL_CONFIGS="_configs/${CONFIG_GROUP}"
          else
            FULL_CONFIGS="${{ needs.pre-check.outputs.deploy_configs }}"
          fi
          
          npm run eb -- output --baseurl="/${DIR_NAME}" --configs="${FULL_CONFIGS}" --dontserve=true --deploy=true
          
          mkdir -p "_build_staging/${DIR_NAME}"
          cp -r "_site/${DIR_NAME}"/* "_build_staging/${DIR_NAME}/"
        done

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::381492306053:role/GitHubActionsS3Access
        aws-region: eu-west-2

    - name: Deploy to S3
      run: |
        TARGET_BRANCH="${{ needs.pre-check.outputs.target_branch }}"
        BUCKET="${{ needs.pre-check.outputs.deploy_bucket }}"
        
        if [ "$TARGET_BRANCH" = "live" ]; then
          BUCKET_SUFFIX="-live"
        else
          BUCKET_SUFFIX="-staging"
        fi
        
        S3_BUCKET="${BUCKET}${BUCKET_SUFFIX}"
        
        IFS=',' read -ra DIRS <<< "${{ needs.pre-check.outputs.build_dirs }}"
        
        # Get the unique root directories
        ROOT_DIRS=$(for dir in "${DIRS[@]}"; do echo "${dir%%/*}"; done | sort -u)
        
        for ROOT_DIR in $ROOT_DIRS; do
          echo "Syncing directory '$ROOT_DIR' to s3://${S3_BUCKET}/${ROOT_DIR}/"
          aws s3 sync "_build_staging/${ROOT_DIR}/" "s3://${S3_BUCKET}/${ROOT_DIR}/" --delete
        done
        
        echo "S3_BUCKET=${S3_BUCKET}" >> $GITHUB_ENV

    - name: Deployment Summary
      run: |
        echo "âœ… Successfully deployed to ${S3_BUCKET}"
        echo "ðŸ“ Source branch: ${{ github.ref_name }}"
        echo "ðŸ“‚ Deployed directories: ${{ needs.pre-check.outputs.build_dirs }}"
        echo "ðŸ”§ Build configs used: ${{ needs.pre-check.outputs.build_configs }}"
        echo "ðŸ”— Called from: ${{ github.repository }}"

  pre-check-media:
    runs-on: ubuntu-latest
    outputs:
      should_sync: ${{ steps.check_media.outputs.should_sync }}
      region: ${{ steps.check_media.outputs.region }}
      config: ${{ steps.check_media.outputs.config }}
    steps:
      - name: Checkout config file
        uses: actions/checkout@v4
        with:
          sparse-checkout: ${{ inputs.config-file }}
          fetch-depth: 1

      - name: Check for media sync
        id: check_media
        run: |
          CONFIG_FILE="${{ inputs.config-file }}"
          
          if [ ! -f "$CONFIG_FILE" ] || ! jq -e 'has("media")' "$CONFIG_FILE" > /dev/null || [[ $(jq -r '.media.syncs | length' "$CONFIG_FILE") -eq 0 ]]; then
            echo "No media sync configuration found. Skipping."
            echo "should_sync=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CURRENT_BRANCH="${{ github.ref_name }}"
          if [ "$CURRENT_BRANCH" != "live" ] && [ "$CURRENT_BRANCH" != "staging" ]; then
            echo "Branch '$CURRENT_BRANCH' is not 'live' or 'staging'. Skipping S3 sync."
            echo "should_sync=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "should_sync=true" >> $GITHUB_OUTPUT
          echo "region=$(jq -r '.media.region' "$CONFIG_FILE")" >> $GITHUB_OUTPUT
          echo "config=$(jq -c . "$CONFIG_FILE")" >> $GITHUB_OUTPUT

  sync-media-to-s3:
    needs: pre-check-media
    if: needs.pre-check-media.outputs.should_sync == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::381492306053:role/GitHubActionsS3Access
          aws-region: ${{ needs.pre-check-media.outputs.region }}

      - name: Sync media to S3
        run: |
          CURRENT_BRANCH="${{ github.ref_name }}"
          echo '${{ needs.pre-check-media.outputs.config }}' | jq -r '.media.syncs[] | [.bucket, .source, .destination, .options] | @tsv' | while IFS=$'\t' read -r bucket source dest options; do
            if [ "$CURRENT_BRANCH" = "live" ]; then
              bucket="${bucket}-live"
            else
              bucket="${bucket}-staging"
            fi
            
            echo "Syncing $source to s3://$bucket/$dest/ with options: $options"
            
            # Read the options string into an array to handle arguments with spaces correctly.
            read -r -a options_array <<< "$options"
            
            # Sync to S3, expanding the options array
            aws s3 sync "$source/" "s3://$bucket/$dest/" "${options_array[@]}"
          done

  pre-check-vercel:
    runs-on: ubuntu-latest
    outputs:
      should_trigger: ${{ steps.check_vercel.outputs.should_trigger }}
      trigger_url: ${{ steps.check_vercel.outputs.trigger_url }}
    steps:
      - name: Checkout config file
        uses: actions/checkout@v4
        with:
          sparse-checkout: ${{ inputs.config-file }}
          fetch-depth: 1

      - name: Check for vercel trigger
        id: check_vercel
        run: |
          CONFIG_FILE="${{ inputs.config-file }}"
          
          if [ ! -f "$CONFIG_FILE" ] || ! jq -e 'has("vercel")' "$CONFIG_FILE" > /dev/null || ! jq -e '.vercel | has("trigger")' "$CONFIG_FILE" > /dev/null; then
            echo "No vercel trigger configuration found. Skipping."
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CURRENT_BRANCH="${{ github.ref_name }}"
          if [ "$CURRENT_BRANCH" != "live" ] && [ "$CURRENT_BRANCH" != "staging" ]; then
            echo "Branch '$CURRENT_BRANCH' is not 'live' or 'staging'. Skipping Vercel trigger."
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          TRIGGER_URL=$(jq -r ".vercel.trigger.${CURRENT_BRANCH}" "$CONFIG_FILE")
          if [ -z "$TRIGGER_URL" ] || [ "$TRIGGER_URL" == "null" ]; then
            echo "No Vercel trigger URL found for branch '$CURRENT_BRANCH'. Skipping."
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "should_trigger=true" >> $GITHUB_OUTPUT
          echo "trigger_url=${TRIGGER_URL}" >> $GITHUB_OUTPUT

  trigger-vercel-deploy:
    needs: [deploy-to-book-server, sync-media-to-s3, pre-check-vercel]
    if: always() && needs.pre-check-vercel.outputs.should_trigger == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Vercel Deploy
        run: curl -X POST "${{ needs.pre-check-vercel.outputs.trigger_url }}"